#!/bin/bash

if [ "$#" -lt 2 ] || [ "$1" = "-h" ]; then
	echo "usage: promote <tag> <release-branch>"
	exit
fi

prerelease_tag=$1
target_branch=$2

index=`expr index "$prerelease_tag" -`
release_tag=${prerelease_tag:0:index-1}

function unstash_changes()
{
	if [ "$stash_output" != "No local changes to save" ]; then
		git stash pop || exit_with_err
	fi
}

function exit_with_err() {
	echo "Error performing operation. Exiting."
	unstash_changes
	if [ $1 ]; then
		exit $1
	else
		exit 1
	fi
}

current_branch="$(git symbolic-ref --short HEAD)"
stash_output="$(git stash save)"

git fetch -q --tags || exit_with_err
git checkout -q $target_branch || exit_with_err 3
git merge -q --ff-only origin/$target_branch || exit_with_err 4
git merge -q -S --no-ff $prerelease_tag || exit_with_err 5
git tag -s $release_tag -m $release_tag || exit_with_err 6
git push -q origin $target_branch --tags || exit_with_err

unstash_changes

exit 0
